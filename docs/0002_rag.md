# Perplexity-like Frontend Implementation Spec for Cursor Claude

## Overview
Build a React + TypeScript frontend component that replicates Perplexity's search experience for veterinary Q&A, integrating with the existing RAG API endpoint.

## Project Setup Requirements

### Dependencies to Add
```bash
npm install axios react-markdown lucide-react
# Already available: react-router-dom, tailwindcss, lucide-react
```

### File Structure to Create
```
src/
├── components/
│   ├── search/
│   │   ├── SearchInterface.tsx
│   │   ├── AnswerDisplay.tsx  
│   │   ├── SourcesPanel.tsx
│   │   ├── LoadingState.tsx
│   │   └── SearchHistory.tsx
│   └── shared/
│       ├── CitationBubble.tsx
│       └── SourceCard.tsx
├── pages/
│   ├── SearchPage.tsx
│   └── SearchResult.tsx
├── hooks/
│   ├── useRAGSearch.ts
│   └── useSearchHistory.ts
├── types/
│   └── rag.ts
└── utils/
    └── searchUtils.ts
```

## Type Definitions

### 1. Core Types (`types/rag.ts`)
```typescript
// Copy the exact response structure from the provided API response
interface SourceReference {
  id: string;
  title: string;
  url: string;
  chunk_info: string;
  relevance_score: number;
  audience: string;
  authority_level: string;
  publisher: string;
  publication_year: number;
  species: string[];
  symptoms: string[];
}

interface RAGResponse {
  answer: string;
  sources: SourceReference[];
  query_metadata: {
    processing_time_seconds: number;
    pinecone_results_count: number;
    sources_count: number;
    question: string;
    timestamp: string;
    openai_model: string;
    status: string;
  };
}

interface SearchState {
  query: string;
  isLoading: boolean;
  result: RAGResponse | null;
  error: string | null;
  searchId: string | null;
}

interface SearchHistoryItem {
  id: string;
  query: string;
  timestamp: string;
  preview: string; // First 100 chars of answer
}
```

## Component Implementation Requirements

### 1. Main Search Interface (`components/search/SearchInterface.tsx`)

**Features to Implement:**
- Large, prominent search input (Perplexity-style)
- Auto-expanding textarea that grows with content
- Search button with loading spinner
- Keyboard shortcuts (Enter to search, Escape to clear)
- Recent searches dropdown
- Placeholder with example vet questions

**State Management:**
```typescript
const [searchState, setSearchState] = useState<SearchState>({
  query: '',
  isLoading: false, 
  result: null,
  error: null,
  searchId: null
});
```

**API Integration:**
```typescript
const handleSearch = async (query: string) => {
  const response = await fetch('/api/rag/query', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      question: query,
      max_results: 5,
      temperature: 0.1 
    })
  });
  // Handle response and update state
};
```

### 2. Answer Display (`components/search/AnswerDisplay.tsx`)

**Features to Implement:**
- **Typewriter Effect**: Animate text appearance character by character
- **Citation Parsing**: Parse `[1]`, `[2]`, `[3]` in answer text and convert to clickable bubbles
- **Markdown Support**: Use react-markdown for formatting
- **Copy Button**: Copy answer to clipboard
- **Share Button**: Generate shareable URL
- **Follow-up Suggestions**: Show 3-4 related questions

**Citation Implementation:**
```typescript
const parseCitations = (text: string) => {
  return text.replace(/\[(\d+)\]/g, '<CitationBubble number="$1" />');
};
```

**Typewriter Effect:**
```typescript
const TypewriterText = ({ text, speed = 30 }) => {
  const [displayedText, setDisplayedText] = useState('');
  
  useEffect(() => {
    // Implement character-by-character animation
  }, [text, speed]);
};
```

### 3. Sources Panel (`components/search/SourcesPanel.tsx`)

**Features to Implement:**
- **Expandable Source Cards**: Click to expand/collapse
- **Authority Badges**: Visual indicators for "expert", publisher
- **Hover Citations**: When hovering over citation bubbles, highlight corresponding source
- **External Link Icons**: Show when links go to external sites
- **Species Tags**: Show which animals the source covers
- **Relevance Scores**: Display as progress bars or stars

**Source Card Layout:**
```
┌─────────────────────────────────────┐
│ [1] Merck Veterinary Manual    🏛️   │
│ ─────────────────────────────────── │
│ Drugs Used to Treat Diarrhea...     │
│ 📅 2024 | 👥 Expert | ⭐ 0.577      │
│ 🐕 Dog, Cat, Horse                  │
│ ──────────────────────────────────  │
│ Chunk: #0.0 | View Source →         │
└─────────────────────────────────────┘
```

### 4. Loading State (`components/search/LoadingState.tsx`)

**Features to Implement:**
- **Progressive Loading**: Show different states
  1. "Searching knowledge base..." (0-3 seconds)
  2. "Analyzing veterinary sources..." (3-8 seconds)  
  3. "Generating expert response..." (8+ seconds)
- **Animated Icons**: Spinning search icon, pulsing dots
- **Cancel Button**: Allow users to cancel long-running requests

### 5. Search History (`components/search/SearchHistory.tsx`)

**Features to Implement:**
- **Sidebar Panel**: Collapsible history sidebar
- **Recent Searches**: Last 20 searches with timestamps
- **Quick Access**: Click to re-run previous searches
- **Clear History**: Option to clear all history
- **Search Within History**: Filter previous searches

## Routing Implementation

### 1. Add Routes to App.tsx
```typescript
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';

function App() {
  return (
    <Router>
      <Routes>
        <Route path="/" element={<SearchPage />} />
        <Route path="/search" element={<SearchPage />} />
        <Route path="/search/:searchId" element={<SearchResult />} />
      </Routes>
    </Router>
  );
}
```

### 2. Search Page (`pages/SearchPage.tsx`)
- Main landing page with large search interface
- Show search history in sidebar
- Handle both empty state and search results state
- URL updates when searching: `/search?q=your+question`

### 3. Shareable Results (`pages/SearchResult.tsx`)
- Load specific search by ID: `/search/abc123`
- Same UI as search page but with pre-loaded results
- Allow new searches from this page
- Social sharing meta tags

## Custom Hooks

### 1. useRAGSearch (`hooks/useRAGSearch.ts`)
```typescript
export const useRAGSearch = () => {
  const [state, setState] = useState<SearchState>(/* initial state */);
  
  const search = async (query: string) => {
    // API call implementation
    // Error handling
    // State updates
  };
  
  const clearResults = () => {
    // Clear current results
  };
  
  return { ...state, search, clearResults };
};
```

### 2. useSearchHistory (`hooks/useSearchHistory.ts`)
```typescript
export const useSearchHistory = () => {
  const [history, setHistory] = useState<SearchHistoryItem[]>([]);
  
  const addSearch = (item: SearchHistoryItem) => {
    // Add to history, limit to 20 items
    // Save to localStorage
  };
  
  const clearHistory = () => {
    // Clear all history
  };
  
  return { history, addSearch, clearHistory };
};
```

## Styling Guidelines

### 1. Tailwind Classes for Perplexity Look
```css
/* Main search input */
.search-input {
  @apply w-full max-w-4xl mx-auto px-6 py-4 text-lg border-2 border-gray-200 rounded-2xl focus:border-blue-500 focus:ring-0 resize-none;
}

/* Citation bubbles */
.citation-bubble {
  @apply inline-flex items-center justify-center w-6 h-6 bg-blue-500 text-white text-xs font-bold rounded-full ml-1 cursor-pointer hover:bg-blue-600;
}

/* Source cards */
.source-card {
  @apply bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer;
}

/* Answer text */
.answer-text {
  @apply text-gray-800 leading-relaxed text-lg;
}
```

### 2. Responsive Design
- Mobile-first approach
- Stack sources below answer on mobile
- Collapsible sidebar on mobile
- Touch-friendly buttons and interactions

## Performance Requirements

### 1. Optimization Techniques
- **Debounced Search**: Wait 300ms after user stops typing
- **Request Cancellation**: Cancel previous requests when new search starts
- **Memoization**: Memo heavy components like SourceCard
- **Lazy Loading**: Load search history only when sidebar opens
- **Error Boundaries**: Catch and display errors gracefully

### 2. Loading Performance
- Show loading state immediately (< 100ms)
- Progressive disclosure of information
- Skeleton screens for source cards
- Optimistic UI updates where possible

## Error Handling

### 1. Error States to Handle
- Network connectivity issues
- API timeouts (> 30 seconds)
- Invalid API responses
- No results found
- Rate limiting
- Server errors (5xx)

### 2. User Experience
- Friendly error messages (no technical jargon)
- Retry buttons for transient errors
- Fallback content when possible
- Clear indication of what went wrong

## Testing Requirements

### 1. Unit Tests
- Search input validation
- Citation parsing logic
- State management in hooks
- Error handling scenarios

### 2. Integration Tests  
- Full search flow end-to-end
- API integration with mocked responses
- Routing and navigation
- localStorage persistence

## Accessibility

### 1. Requirements
- ARIA labels for all interactive elements
- Keyboard navigation support
- Screen reader compatibility
- Focus management
- High contrast mode support

### 2. Implementation
- Use semantic HTML elements
- Proper heading hierarchy (h1, h2, h3)
- Alt text for all images/icons
- Skip links for keyboard users

## Success Criteria

### 1. Functional Requirements
- Search executes successfully with loading states
- Results display with proper formatting and citations
- Sources panel shows all metadata correctly
- Sharing URLs work properly
- Search history persists across sessions

### 2. UX Requirements
- Interface feels responsive and fast (< 200ms interactions)
- Loading states are clear and informative
- Error messages are helpful and actionable
- Mobile experience is fully functional
- Citations are clearly linked to sources

### 3. Technical Requirements
- TypeScript strict mode passes
- No console errors in development
- Bundle size reasonable (< 500KB gzipped)
- Lighthouse score > 90 for performance
- Works in Chrome, Firefox, Safari, Edge

## Implementation Order

1. **Setup**: Types, basic routing, API integration
2. **Core Search**: SearchInterface component with basic functionality
3. **Results Display**: AnswerDisplay with citation parsing
4. **Sources Panel**: Source cards with metadata display
5. **Loading States**: Progressive loading indicators
6. **Search History**: Persistence and sidebar
7. **Routing**: Shareable URLs and navigation
8. **Polish**: Animations, error handling, accessibility
9. **Testing**: Unit tests and integration tests
10. **Mobile Optimization**: Responsive design refinements