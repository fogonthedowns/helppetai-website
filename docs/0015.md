# Backend Team Responses to iOS Team Questions

## Questions from Frontend iOS Team

### 1. Date Parameter Behavior
**Question:** Should the iOS app always pass a date parameter, or should the backend default to "today" when no date is provided?

**Answer:** The backend should default to "today" when no date is provided. 
- **Recommended:** `GET /api/v1/dashboard/vet/{id}/today` (no date = today)
- **Optional:** `GET /api/v1/dashboard/vet/{id}/today?date=2025-09-01` (specific date)

**Backend Implementation:** The endpoint should use `date: Optional[str] = Query(None)` and default to `datetime.now().date()` when None.

### 2. S3 Upload Flow Verification
**Question:** Is the 3-step S3 upload flow correct?

**Answer:** âœ… **YES, the flow is correct:**
1. `POST /api/v1/recordings/upload/initiate` â†’ Get presigned URL
2. `POST` to S3 with multipart form data (using presigned URL fields)
3. `POST /api/v1/recordings/upload/complete/{id}` â†’ Mark complete

**Required S3 Fields:** Use ALL fields from the `upload_fields` response:
```json
{
  "key": "recordings/...",
  "Content-Type": "audio/m4a",
  "x-amz-server-side-encryption": "AES256",
  "policy": "...",
  "x-amz-credential": "...",
  "x-amz-algorithm": "AWS4-HMAC-SHA256",
  "x-amz-date": "...",
  "x-amz-signature": "..."
}
```

**Failure Handling:** If step 2 succeeds but step 3 fails:
- Recording remains in "uploading" status
- iOS app should retry step 3 (complete endpoint)
- Backend will eventually clean up orphaned uploads (future enhancement)

### 3. Recording Status Flow
**Question:** What are all possible status values?

**Answer:** Status values (from `RecordingStatus` enum):
- `"uploading"` - Initial state after initiate
- `"uploaded"` - After successful S3 upload + complete call
- `"processing"` - When transcription starts (future)
- `"transcribed"` - When transcription completes (future)
- `"failed"` - When any step fails

**Polling:** Currently **fire-and-forget**. Future enhancement may add WebSocket updates for transcription status.

### 4. Error Response Format
**Question:** Do all error responses follow the same format?

**Answer:** âœ… **YES, all errors use FastAPI standard format:**
```json
{
  "detail": "Error message"
}
```

**HTTP Status Codes to Handle:**
- `400` - Bad Request (validation errors)
- `401` - Unauthorized (token expired/invalid)
- `403` - Forbidden (access denied)
- `404` - Not Found
- `422` - Validation Error (Pydantic)
- `500` - Internal Server Error

### 5. Authentication Token Expiry
**Question:** How long do JWT tokens last?

**Answer:** 
- **Token Lifetime:** 8 hours (`ACCESS_TOKEN_EXPIRE_MINUTES = 480`)
- **Auto-refresh:** Not currently implemented
- **Expiry Handling:** When token expires:
  1. API returns `401 Unauthorized`
  2. iOS app should redirect to login screen
  3. User re-authenticates to get new token

**Future Enhancement:** Refresh token mechanism

### 6. Field Clarifications
**Question:** What's the difference between `visit_id` and `appointment_id`?

**Answer:**
- **`appointment_id`** - The scheduled appointment (required)
- **`visit_id`** - The actual visit record when appointment starts (optional, created when "Start Visit" is tapped)
- **Usage:** Recordings are linked to both for complete traceability

**Question:** Is `duration_formatted` always in "MM:SS" format?

**Answer:** âœ… **YES**, format is always `"MM:SS"` (e.g., "02:35" for 2 minutes 35 seconds)

### 7. Production vs Development
**Question:** Will the production API base URL be different?

**Answer:** 
- **Production URL:** `https://api.helppet.ai` âœ… (current)
- **Development URL:** `http://localhost:8000` (for local testing)
- **Authentication:** Same JWT format for both environments

### 8. Rate Limiting
**Question:** Are there any rate limits?

**Answer:** 
- **Current:** No rate limiting implemented
- **Recommended Retry Strategy:**
  - Exponential backoff: 1s, 2s, 4s, 8s
  - Max 3 retries for 5xx errors
  - No retry for 4xx errors (except 401)
- **Future:** May implement rate limiting (100 requests/minute per user)

## Additional Backend Notes for iOS Team

### Recording Metadata Field
**Important:** The field is `recording_metadata` (not `metadata`) due to SQLAlchemy reserved word conflict.

### S3 Bucket Configuration
- **Bucket:** `helppet-audio-recordings`
- **Region:** `us-east-1`
- **Max File Size:** 100MB
- **Supported Formats:** `.m4a`, `.mp3`, `.wav`

### Error Handling Best Practices
1. **Always check HTTP status codes first**
2. **Parse `detail` field for user-friendly messages**
3. **Log full response for debugging**
4. **Handle network timeouts gracefully**

### Testing Endpoints
Use these for testing:
- **Health Check:** `GET /health` (no auth required)
- **Auth Test:** `GET /api/v1/auth/me` (requires JWT)
- **Dashboard Test:** `GET /api/v1/dashboard/vet/{user_id}/today`

---

**Status:** All backend endpoints are deployed and working âœ…  
**Next Steps:** iOS team can implement based on these clarifications ðŸš€
